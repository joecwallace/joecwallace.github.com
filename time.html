<!doctype html>
<html>
<head>
  <title>time</title>
  <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.0.0/moment.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.2/mustache.min.js"></script>

  <script type="text/javascript">
  function weekdaysInRange(startDate, endDate) {
    var days = endDate.diff(startDate, 'days') + 1,
      weekdays = (Math.floor(days / 7) * 5) + (days % 7),
      startDayOfWeek = parseInt(startDate.format('d')),
      endDayOfWeek = parseInt(endDate.format('d'));

    if (startDayOfWeek == 0)
      weekdays -= 1;
    else if (startDayOfWeek == 6)
      weekdays -= 2;

    if (endDayOfWeek == 0)
      weekdays -= 2;
    else if (endDayOfWeek == 6)
      weekdays -= 1;

    return weekdays;
  }

  $(document).ready(function() {
    $('#submit').click(function(evt) {
      var now = moment(),
        startYear = moment().startOf('year'),
        endYear = moment().endOf('year'),

        workedHours = parseFloat($('#hoursWorked').val()),
        expectedHours = parseFloat($('#hoursExpected').val()),

        weekdaysPast = weekdaysInRange(startYear, now),
        weekdaysYear = weekdaysInRange(startYear, endYear),

        data = {
          hoursPerDay: 8,
          workedHours: workedHours,
          expectedHours: expectedHours,
          weekdaysPast: weekdaysPast,
          weekdaysYear: weekdaysYear,

          workableHoursPast: function() {
            return this.weekdaysPast * 8;
          },
          workedPercentagePast: function() {
            return this.percentage(this.workedHours / this.workableHoursPast()).toFixed(1);
          },
          hoursYear: function() {
            return this.weekdaysYear * this.hoursPerDay;
          },
          weekdaysPercentage: function() {
            return this.percentage(this.weekdaysPast / this.weekdaysYear).toFixed(1);
          },
          workedPercentageYear: function() {
            return this.percentage(this.workedHours / this.expectedHours).toFixed(1);
          },
          expectedHoursPast: function() {
            return (this.workableHoursPast() * (this.expectedHours / this.hoursYear())).toFixed(1);
          },
          hoursOverage: function() {
            return (this.workedHours - this.expectedHoursPast()).toFixed(1);
          },

          status: function() {
            return this.hoursOverage() >= 0 ? 'success' : 'error';
          },
          title: function() {
            return this.hoursOverage() >= 0 ? 'Well done!' : 'Oh, snap!';
          },
          overUnder: function() {
            return this.hoursOverage() >= 0 ? 'over' : 'under';
          },

          percentage: function(num) {
            return num * 100;
          }
        };

      $('#message').html(
        Mustache.render($('#messageTemplate').html(), data)
      );

      evt.preventDefault();
    });
  });
  </script>
</head>
<body>

  <div class="container">
    <div class="row">
      <h2 class="span12">Billable Hours Calculator</h2>
    </div>
    <div class="row">
      <form>
        <fieldset class="span4">
          <label class="control-label" for="hoursWorked">Hours worked (YTD)</label>
          <input id="hoursWorked" name="hoursWorked" type="text"><br>
          <label class="control-label" for="hoursExpected">Hours expected (year)</label>
          <input id="hoursExpected" name="hoursExpected" value="1900" type="text"><br>
          <input id="submit" class="btn btn-primary" name="submit" type="submit">
        </fieldset>
      </form>
      <div id="message" class="span8">
      </div>
    </div>
  </div>

  <script id="messageTemplate" type="text/template">
    <div class="alert alert-block alert-{{ status }}">
      <h4>{{ title }}</h4>
      <p>There have been {{ weekdaysPast }} weekdays so far this year for a total of {{ workableHoursPast }} hours.</p>
      <p>You have worked {{ workedHours }} hours &ndash; {{ workedPercentagePast }}% &ndash; of those.</p>
      <p>Of the {{ weekdaysYear }} weekdays &ndash; {{ hoursYear }} hours &ndash; this year, {{ weekdaysPercentage }}% have already passed, and you have worked {{ workedPercentageYear }}% of your expected hours.</p>
      <p>You are currently <strong>{{ hoursOverage }} hours {{ overUnder }}</strong> the expectation of {{ expectedHoursPast }} hours so far this year.
    </div>
  </script>

</body>
</html>
